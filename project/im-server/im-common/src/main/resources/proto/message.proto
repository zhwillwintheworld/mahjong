syntax = "proto3";

package com.sudooom.mahjong.common.proto;

option java_multiple_files = true;
option java_package = "com.sudooom.mahjong.common.proto";
option java_outer_classname = "MessageProtos";

// =============================================================================
// Enums
// =============================================================================

enum Platform {
  PLATFORM_UNKNOWN = 0;
  ANDROID = 1;
  IOS = 2;
  WEB = 3;
  DESKTOP = 4;
  WECHAT = 5;
}

enum ChatType {
  CHAT_TYPE_UNKNOWN = 0;
  CHAT_PRIVATE = 1;
  CHAT_GROUP = 2;
  CHAT_SYSTEM = 3;
  CHAT_MAHJONG = 4;
}

enum MsgType {
  MSG_TYPE_UNKNOWN = 0;
  TEXT = 1;
  IMAGE = 2;
  VOICE = 3;
  VIDEO = 4;
  FILE = 5;
  EMOJI = 6;
  CMD = 7;
}

enum GameType {
  GAME_TYPE_UNKNOWN = 0;
  GAME_MAHJONG = 1;
}

enum ErrorCode {
  SUCCESS = 0;
  UNKNOWN_ERROR = 1;
  AUTH_FAILED = 1001;
  PARAM_ERROR = 1002;
  ROOM_NOT_FOUND = 2001;
  ROOM_FULL = 2002;
  NOT_IN_ROOM = 2003;
}

enum MahjongColor {
  COLOR_UNKNOWN = 0;
  MAN = 1;
  SUO = 2;
  PIN = 3;
  HONORS = 4;
}

enum RoomStatus {
  ROOM_WAITING = 0;
  ROOM_PLAYING = 1;
  ROOM_SETTLING = 2;
}

// =============================================================================
// Client Request (Client -> Access -> Logic)
// =============================================================================

message ClientRequest {
  string req_id = 1;
  int64 timestamp = 2;

  oneof payload {
    ChatSendReq chat_send = 11;
    GameReq game = 12;
    HeartbeatReq heartbeat = 13;
    RoomReq room = 14;
  }
}

message ChatSendReq {
  ChatType chat_type = 1;
  string target_id = 2;
  MsgType msg_type = 3;
  string content = 4;
  map<string, string> ext = 5;
}

message RoomReq {
  enum Action {
    CREATE = 0;
    JOIN = 1;
    LEAVE = 2;
    READY = 3;
  }
  Action action = 1;
  GameType game_type = 2;
  string room_id = 3;
  string room_config = 4;
}

message GameReq {
  string room_id = 1;
  GameType game_type = 2;

  oneof game_data {
    MahjongReq mahjong = 10;
  }
}

message HeartbeatReq {
  int64 client_time = 1;
}

// =============================================================================
// Client Response (Logic -> Access -> Client)
// =============================================================================

message ClientResponse {
  string req_id = 1;
  int64 timestamp = 2;
  ErrorCode code = 3;
  string msg = 4;

  oneof payload {
    // 响应
    ChatSendAck chat_send_ack = 11;
    RoomResp room_resp = 12;
    HeartbeatResp heartbeat_resp = 13;

    // 推送
    ChatPush chat_push = 20;
    GamePush game_push = 21;
    RoomPush room_push = 22;
    SystemPush system_push = 23;
  }
}

message ChatSendAck {
  string msg_id = 1;
  int64 send_time = 2;
}

message RoomResp {
  string room_id = 1;
  RoomInfo room_info = 2;
}

message HeartbeatResp {
  int64 server_time = 1;
}

message ChatPush {
  string msg_id = 1;
  string sender_id = 2;
  UserInfo sender_info = 3;
  ChatType chat_type = 4;
  string target_id = 5;
  MsgType msg_type = 6;
  string content = 7;
  int64 send_time = 8;
  map<string, string> ext = 9;
}

message RoomPush {
  enum Event {
    USER_JOINED = 0;
    USER_LEFT = 1;
    USER_READY = 2;
    GAME_START = 3;
    GAME_OVER = 4;
    ROOM_DISMISSED = 5;
  }
  Event event = 1;
  string room_id = 2;
  string user_id = 3;
  RoomInfo room_info = 4;
}

message GamePush {
  string room_id = 1;
  GameType game_type = 2;

  oneof game_data {
    MahjongPush mahjong = 10;
  }
}

message SystemPush {
  enum Level {
    INFO = 0;
    WARNING = 1;
    ERROR = 2;
  }
  string title = 1;
  string content = 2;
  Level level = 3;
  string action_url = 4;
}

// =============================================================================
// Server Message (模块间系统交互，不含用户业务)
// =============================================================================

message ServerMessage {
  string trace_id = 1;
  string from_service = 2;
  string to_service = 3;
  int64 timestamp = 4;

  oneof payload {
    UserOnlineOffline user_status = 10;
    KickUser kick_user = 11;
    BroadcastCommand broadcast = 12;
    MsgAck ack = 13;
    CompensationCommand compensation = 14;
  }
}

message UserOnlineOffline {
  enum Status {
    ONLINE = 0;
    OFFLINE = 1;
  }
  string user_id = 1;
  Status status = 2;
  string gateway_id = 3;
  string device_id = 4;
  Platform platform = 5;
  int64 timestamp = 6;
}

message KickUser {
  string user_id = 1;
  string reason = 2;
  bool force = 3;
}

message BroadcastCommand {
  repeated string user_ids = 1;
  string room_id = 2;
  ClientResponse message = 3;
}

message MsgAck {
  enum AckType {
    RECEIVED = 0;
    PROCESSED = 1;
    DELIVERED = 2;
    FAILED = 3;
  }
  string ack_id = 1;
  string original_msg_id = 2;
  string original_trace_id = 3;
  AckType ack_type = 4;
  int64 timestamp = 5;
  string error_code = 6;
  string error_msg = 7;
}

message CompensationCommand {
  enum CompensationType {
    RETRY = 0;
    ROLLBACK = 1;
    ALERT = 2;
  }
  string compensation_id = 1;
  string original_trace_id = 2;
  CompensationType type = 3;
  string error_code = 4;
  string error_msg = 5;
  int32 retry_count = 6;
  int32 max_retry = 7;
  bytes original_payload = 10;
}

// =============================================================================
// Common Models
// =============================================================================

message UserInfo {
  string user_id = 1;
  string nickname = 2;
  string avatar = 3;
  int32 level = 4;
  int64 coins = 5;
}

message RoomInfo {
  string room_id = 1;
  string owner_id = 2;
  int32 max_players = 3;
  int32 current_players = 4;
  repeated RoomPlayer players = 5;
  RoomStatus status = 6;
}

message RoomPlayer {
  string user_id = 1;
  UserInfo user = 2;
  bool is_ready = 3;
  int32 seat_index = 4;
  bool is_online = 5;
}

message MahjongTile {
  MahjongColor color = 1;
  int32 value = 2;
  int32 index = 3;
}

message MeldGroup {
  enum MeldType {
    PONG = 0;
    KONG = 1;
    CONCEALED_KONG = 2;
    CHOW = 3;
  }
  MeldType type = 1;
  repeated MahjongTile tiles = 2;
  int32 from_seat = 3;
}

message PlayerPublicInfo {
  int32 seat = 1;
  string user_id = 2;
  repeated MeldGroup melds = 3;
  repeated MahjongTile discarded = 4;
  int32 hand_count = 5;
}

// =============================================================================
// Mahjong Request
// =============================================================================

message MahjongReq {
  enum Action {
    DISCARD = 0;
    PONG = 1;
    KONG = 2;
    HU = 3;
    ZI_MO = 4;
    AUTO = 5;
    PASS = 6;
  }
  Action action = 1;
  MahjongTile tile = 2;
  string event_id = 3;
  string decision_id = 4;
}

// =============================================================================
// Mahjong Push (拆分为多个小消息，避免大对象)
// =============================================================================

message MahjongPush {
  string event_id = 1;

  oneof notification {
    MjGameStart game_start = 10;
    MjTurnChange turn_change = 11;
    MjActionResult action_result = 12;
    MjAskAction ask_action = 13;
    MjSettlement settlement = 14;
    MjTotalResult total_result = 15;
  }
}

// 游戏开始 - 发牌
message MjGameStart {
  repeated MahjongTile hand_tiles = 1;
  repeated PlayerPublicInfo players_public_info = 2;
  int32 remain_cards = 3;
  int32 dealer_seat = 4;
}

// 轮到某人 - 摸牌
message MjTurnChange {
  int32 current_seat = 1;
  int32 remain_cards = 2;
  int32 countdown = 3;
  MahjongTile drawn_tile = 4;  // 仅推送给当前玩家
}

// 动作结果 - 某人出牌/碰/杠/胡
message MjActionResult {
  int32 action_seat = 1;
  string action_user_id = 2;
  MahjongReq.Action action = 3;
  MahjongTile tile = 4;
  repeated MahjongTile related_tiles = 5;  // 碰/杠相关的牌
}

// 询问操作 - 是否碰/杠/胡
message MjAskAction {
  string decision_id = 1;
  int32 countdown = 2;
  MahjongTile trigger_tile = 3;  // 触发询问的牌
  repeated MahjongReq.Action allowed_actions = 4;
}

// 单局结算
message MjSettlement {
  int32 winner_seat = 1;
  int32 win_type = 2;  // 0: 自摸, 1: 点炮
  int32 loser_seat = 3;  // 点炮时有值
  repeated int32 score_changes = 4;
  repeated MahjongTile winning_tiles = 5;
  string fan_description = 6;
  int32 fan_count = 7;
}

// 总结算
message MjTotalResult {
  repeated MjPlayerResult player_results = 1;
}

message MjPlayerResult {
  int32 seat = 1;
  string user_id = 2;
  int32 total_score = 3;
  int32 win_count = 4;
  int32 lose_count = 5;
}
